name: Deploy to Dev

on:
  push:
    branches:
      - develop

env:
  ENVIRONMENT: dev
  ACR_NAME: ${{ secrets.ACR_NAME }}
  NAMESPACE: sampleapi-dev

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: development
      url: http://dev.sampleapi.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Log into Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZ_CREDENTIALS }}
      
      - name: Verify Azure login
        run: |
          az account show
          echo "Logged in successfully"
      
      - name: Build and Push using ACR Build
        run: |
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image sampleapi/sampleapi:dev-${{ github.sha }} \
            --image sampleapi/sampleapi:dev-latest \
            --file SampleAPI/Dockerfile \
            SampleAPI/
      
      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create ConfigMap
        run: |
          kubectl create configmap sampleapi-config \
            --from-literal=ASPNETCORE_ENVIRONMENT=Development \
            --from-literal=LOG_LEVEL=Debug \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create Secrets
        run: |
          kubectl create secret generic sampleapi-secrets \
            --from-literal=DATABASE_CONNECTION_STRING="Server=localhost" \
            --from-literal=API_KEY="dev-key" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to AKS
        uses: azure/k8s-deploy@v4
        with:
          namespace: ${{ env.NAMESPACE }}
          manifests: |
            k8s/base/deployment.yml
            k8s/base/service.yml
          images: |
            ${{ env.ACR_NAME }}.azurecr.io/sampleapi/sampleapi:dev-${{ github.sha }}
      
      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/sampleapi -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl get pods -n ${{ env.NAMESPACE }}