name: Deploy to Dev

on:
  push:
    branches:
      - develop

env:
  ENVIRONMENT: dev
  ACR_NAME: ${{ secrets.ACR_NAME }}
  NAMESPACE: sampleapi-dev

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: development
      url: http://dev.sampleapi.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Log into Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZ_CREDENTIALS }}
      
      - name: Login to ACR with Token
        run: |
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer -o tsv)
          echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_ENV
          
          TOKEN=$(az acr login --name ${{ env.ACR_NAME }} --expose-token --query accessToken -o tsv)
          echo $TOKEN | docker login $ACR_LOGIN_SERVER -u 00000000-0000-0000-0000-000000000000 --password-stdin
      
      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG="${{ env.ACR_LOGIN_SERVER }}/sampleapi/sampleapi"
          
          docker build \
            -f SampleAPI/Dockerfile \
            -t $IMAGE_TAG:dev-latest \
            -t $IMAGE_TAG:dev-${{ github.sha }} \
            SampleAPI/
          
          docker push $IMAGE_TAG:dev-latest
          docker push $IMAGE_TAG:dev-${{ github.sha }}
      
      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create ConfigMap
        run: |
          kubectl create configmap sampleapi-config \
            --from-literal=ASPNETCORE_ENVIRONMENT=Development \
            --from-literal=LOG_LEVEL=Debug \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create Secrets
        run: |
          kubectl create secret generic sampleapi-secrets \
            --from-literal=DATABASE_CONNECTION_STRING="Server=localhost" \
            --from-literal=API_KEY="dev-key" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to AKS
        uses: azure/k8s-deploy@v4
        with:
          namespace: ${{ env.NAMESPACE }}
          manifests: |
            k8s/base/deployment.yml
            k8s/base/service.yml
          images: |
            ${{ env.ACR_LOGIN_SERVER }}/sampleapi/sampleapi:dev-${{ github.sha }}
      
      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/sampleapi -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl get pods -n ${{ env.NAMESPACE }}